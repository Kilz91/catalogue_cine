rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Collection users - Profils utilisateurs
    match /users/{userId} {
      // Permettre à tout utilisateur authentifié de LIRE les profils
      allow read: if request.auth != null;
      
      // Seul le propriétaire peut MODIFIER son profil
      allow write: if request.auth.uid == userId;
      
      // Sous-collection progress
      match /progress/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Sous-collection catalog
      match /catalog/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Collection friend_requests - Demandes d'amis
    match /friend_requests/{requestId} {
      allow read: if request.auth != null && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
      
      allow create: if request.auth != null && 
        request.resource.data.senderId == request.auth.uid;
      
      allow delete: if request.auth != null && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
    }
    
    // Collection friendships - Amitiés établies
    match /friendships/{friendshipId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.friendId == request.auth.uid);
      
      allow create: if request.auth != null;
      
      allow delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.friendId == request.auth.uid);
    }
    
    // Collection activities - Feed des activités
    match /activities/{activityId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Création : uniquement l'auteur de l'activité
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // Suppression : uniquement l'auteur
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Collection recommendations - Recommandations
    match /recommendations/{recommendationId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Écriture : seulement via Cloud Functions (admin)
      allow write: if false;
    }
    
    // Collection conversations - Conversations de chat
    match /conversations/{conversationId} {
      // Lecture : seulement si on est participant
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.participantIds;
      
      // Création : seulement si on est dans les participants
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participantIds;
      
      // Mise à jour : seulement si on est participant (pour lastMessage, unreadCount)
      allow update: if request.auth != null && 
        request.auth.uid in resource.data.participantIds;
      
      // Suppression : seulement si on est participant
      allow delete: if request.auth != null && 
        request.auth.uid in resource.data.participantIds;
    }
    
    // Collection messages - Messages de chat
    match /messages/{messageId} {
      // Lecture : seulement si on est participant de la conversation
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds;
      
      // Création : seulement si on est l'expéditeur ET dans la conversation
      allow create: if request.auth != null && 
        request.resource.data.senderId == request.auth.uid &&
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.participantIds;
      
      // Mise à jour : pour marquer comme lu (isRead)
      allow update: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds;
    }
    
    // Bloquer tout accès par défaut aux autres collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
